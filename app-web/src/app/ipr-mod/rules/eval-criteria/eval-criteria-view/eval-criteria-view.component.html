<div class="row cq-ipr-rl-cont">
    <mat-card class="cq-ipr-rl-cont-card">
        <mat-card-header>
            <mat-card-title>Evaluation Criteria</mat-card-title>
            <mat-card-subtitle [hidden]="hideBreadCrumb">
                <app-ng-dynamic-breadcrumb fontSize="12px" bgColor="#fff" fontColor="#ff6600" lastLinkColor="#0430ad">
                </app-ng-dynamic-breadcrumb>
            </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content class="cq-ipr-rl-card-cont">
            <div class="row cq-row">
                <div class="row cq-row">
                    <div class="jumbotron jumbotron-fluid">
                        <app-close-btn></app-close-btn>
                        <p class="lead">Note!</p>
                        <p>Keep a note that Evaluation Criteria will be used
                            in IPR process during RFP addition, so modify with caution.</p>
                    </div>
                </div>
                <div class="col-md-12 no-padding">
                    <mat-chip-list>
                        <mat-chip *ngIf="rulesObj?.effectiveDate && is_admin" class="bg-color-white cqr-chip">
                            <mat-icon class="no-margin primary-color cqr-chip-icon">today</mat-icon>Effective From -
                            {{rulesObj?.effectiveDate|date:'dd/MM/yyyy'}}
                        </mat-chip>
                        <mat-chip *ngIf="!rulesObj?.effectiveDate && is_admin" class="bg-color-white cqr-chip">
                            <mat-icon class="no-margin primary-color cqr-chip-icon">today</mat-icon>Effective From -
                            {{publishDate}}
                        </mat-chip>

                        <mat-chip class="bg-color-white cqr-chip" *ngIf="is_admin">
                            <mat-icon class="no-margin primary-color cqr-chip-icon">location_on</mat-icon>Status -
                            {{rulesObj?.currentState}}
                        </mat-chip>
                    </mat-chip-list>
                </div>
                <div class="col-md-12 no-padding">
                    <table class="cq-ipr-doc-temp-table">
                        <thead class="mat-row">
                            <tr class="cq-ipr-doc-temp mat-row cdk-row ng-star-inserted">
                                <th>Insurance Category</th>
                                <th>Insurance Plan</th>
                                <th>Ready to Publish</th>
                                <th></th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tr *ngFor="let combination of combination_data"
                            class="cq-ipr-doc-temp mat-row cdk-row ng-star-inserted">
                            <td class="cdk-cell cdk-column-id mat-column-id ng-star-inserted">
                                {{combination?.category_name}}
                            </td>
                            <td class="cdk-cell cdk-column-id mat-column-id ng-star-inserted">
                                {{combination?.plan_category_name}}
                            </td>
                            <td class="cdk-cell cdk-column-id mat-column-id ng-star-inserted">
                                {{combination?.published}}
                            </td>
                            <td>
                                <mat-icon class="cqr-eval-change-icon"
                                    [style.visibility]="combination.isChange ? 'visible' : 'hidden'">
                                    published_with_changes</mat-icon>
                            </td>
                            <td>
                                <button mat-icon-button color="primary" [matMenuTriggerFor]="appMenu">
                                    <mat-icon>more_vert</mat-icon>
                                </button>

                                <mat-menu #appMenu="matMenu">
                                    <ng-container>
                                        <button mat-menu-item (click)="handleMenu(combination)">
                                            <mat-icon color="primary">edit</mat-icon>
                                            <ng-container>View/Edit</ng-container>
                                        </button>
                                    </ng-container>
                                </mat-menu>

                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <ng-container *ngFor="let rule of combination_rules[selectCombIndex]?.ruleList; index as idx;">
                <div class="row" *ngIf="!rule?.isRule && !rule.isMultiple">
                    <div class="cqr-eval-input-label">
                        <label class="cq-ipr-rl-form-lbl">{{ rule.ruleName }} <span *ngIf="rule?.isMandatory">*</span>
                            <span *ngIf="rule?.ruleLabel">({{rule?.ruleLabel}})</span>
                            <span *ngIf="rule.isNew" class="badge badge-secondary cq-accent-color">New</span>
                        </label>
                    </div>
                    <div class="col-lg-3">
                        <mat-form-field *ngFor="let subRule of rule?.iprRulesOpList; let subIndex = index;"
                            class="form-input cq-ipr-rl-form-dd">
                            <input [type]="subRule?.ruleDataType?.itemValue"
                                [disabled]="disableForm || is_published || combination_rules[selectCombIndex]['isPublishable']"
                                matInput [(ngModel)]="subRule.value" autocomplete="off" [readonly]="subRule.isReadable">
                        </mat-form-field>
                    </div>
                </div>
            </ng-container>
            <ng-container *ngFor="let rule of combination_rules[selectCombIndex]?.ruleList; index as idx;">
                <div class="row" *ngIf="!rule?.isRule && rule.isMultiple">
                    <div class="cqr-eval-input-label">
                        <label class="cq-ipr-rl-form-lbl">{{ rule.ruleName }} <span *ngIf="rule?.isMandatory">*</span>
                            <span *ngIf="rule?.ruleLabel">({{rule?.ruleLabel}})</span>
                            <span *ngIf="rule.isNew" class="badge badge-secondary cq-accent-color">New</span>
                        </label>
                    </div>
                    <div class="col-lg-8 cqr-eval-wrap-multiple-inputs">
                        <div *ngFor="let subRule of rule?.iprRulesOpList; let subIndex = index;" class="cqr-eval-label">
                            <h6 class="cqr-eval-multiple-input-heading">{{scores_obj[subRule.label]?.label}}</h6>
                            <input [type]="subRule?.ruleDataType?.itemValue"
                                [disabled]="disableForm || is_published || subRule.isReadable || combination_rules[selectCombIndex]['isPublishable']"
                                class="cqr-rule-eval-input margin-ri-20" [(ngModel)]="subRule.value" autocomplete="off">
                        </div>
                    </div>
                </div>
            </ng-container>
            <div *ngIf="show_inputs && is_admin" class="row">
                <div class="cqr-eval-input-label">
                    <label class="cq-ipr-rl-form-lbl">Rule Change Summary / Remarks *</label>
                </div>
                <div class="col-lg-3">
                    <mat-form-field class="form-input cq-ipr-rl-form-dd">
                        <textarea maxlength="280"
                            [disabled]="disableForm || is_published || combination_rules[selectCombIndex]['isPublishable']"
                            matInput [(ngModel)]="comment" autocomplete="off"></textarea>
                    </mat-form-field>
                </div>
            </div>
            <div class="row" *ngIf="selInsCategory && selInsPlanCategory">
                <div class="col-lg-3">
                    <div class="margin-bt-10">
                        <mat-chip-list>
                            <mat-chip class="bg-color-white cqr-chip row cqr-row-chip">
                                <mat-icon class="no-margin primary-color cqr-chip-icon">today</mat-icon>
                                {{selInsCategory}} - {{selInsPlanCategory}}
                            </mat-chip>
                        </mat-chip-list>
                    </div>
                </div>
            </div>

            <table *ngIf="show_inputs && selectCombIndex != null" class="cqr-eval-table">
                <tr class="cqr-eval-bold">
                    <td>Evaluation Parameters</td>
                    <td class="margin-ri-20 ">Use?</td>
                    <td *ngFor="let item of lovDataObj['scores'];let i = index;" [attr.colspan]="colSpan[item.id]"
                        [ngClass]="{'text-center' : colSpan[item.id] > 1}">{{item?.itemName}}</td>
                </tr>
                <tr class="cqr-eval-bold">
                    <td colspan="2"></td>
                    <td *ngFor="let operator of arithmetic_list; let i = index;" class="text-center ">
                        {{operator?.arithOperator}}</td>
                </tr>
                <ng-container *ngFor="let rule of combination_rules[selectCombIndex]?.ruleList; let i = index;">
                    <tr *ngIf="rule?.isRule">
                        <td class="cqr-eval-input-label">{{rule?.ruleName}}<span *ngIf="rule?.isMandatory">*</span>
                            <span *ngIf="rule?.ruleLabel">{{rule?.ruleLabel}}</span><span *ngIf="rule.isNew"
                                class="badge badge-secondary cq-accent-color">New</span></td>
                        <td>
                            <mat-checkbox class="margin-ri-20"
                                [disabled]="disableForm || is_published || rule['isMandatory']"
                                [checked]="rule['isMandatory']" [(ngModel)]="rule.isActive" type="checkbox"
                                (change)="calculateWeight()"></mat-checkbox>
                        </td>
                        <td *ngFor="let subRule of rule?.iprRulesOpList; let subIndex = index;">
                            <mat-icon class="cqr-eval-change-icon"
                                [style.visibility]="subRule.isChange ? 'visible' : 'hidden'">published_with_changes
                            </mat-icon>
                            <input (input)="handleChange(subRule,i, subIndex)"
                                [disabled]="disableForm || is_published || subRule.isReadable || combination_rules[selectCombIndex]['isPublishable'] || !rule.isActive"
                                [type]="subRule?.ruleDataType?.itemValue"
                                [ngClass]="{'margin-ri-20' : indexObj[subIndex]}"
                                class="cqr-rule-eval-input {{scores_obj[subRule.label]?.label}}"
                                (blur)="calculateWeight();checkValues(subRule,i, subIndex);"
                                [(ngModel)]="subRule.value">
                        </td>
                    </tr>
                </ng-container>
            </table>
            <div *ngIf="show_inputs && selectCombIndex != null" class="row mt-15">
                <div class="col-lg-4">
                    <p class="cqr-eval-input-label">Total Weight</p>
                </div>
                <div class="col-lg-3">
                    <p>{{ weight_sum }}/ 100(%)</p>
                </div>
            </div>
            <div *ngIf="show_inputs && is_admin" class="row">
                <div class="cqr-eval-input-label">
                    <label class="cq-ipr-rl-form-lbl">Ready to Publish</label>
                </div>
                <div class="col-lg-3">
                    <mat-checkbox [disabled]="disableForm" class="cqr-eval-publish" (change)="onPublishChange($event)"
                        [(ngModel)]="combination_rules[selectCombIndex]['isPublishable']" type="checkbox">
                    </mat-checkbox>
                </div>
                <div class="col-lg-3">

                </div>
            </div>
            <div class="row cq-row pull-right" *ngIf="show_inputs">
                <button (click)="backProcess()" mat-raised-button class="cq-accent-color cq-form-btn">Cancel</button>
                <button [disabled]="disableForm" [ngClass]="{'btn-disable': disableForm}" (click)="onBeforeRuleSave()"
                    mat-raised-button
                    class="cq-accent-color cq-form-btn">{{is_admin ? 'Save as Draft' : 'Save'}}</button>
                <button *ngIf="hidePublish" [ngClass]="{'btn-disable': disableForm || is_published==false}"
                    [disabled]="disableForm || is_published==false" (click)="onBeforePublished()" mat-raised-button
                    class="cq-accent-color cq-form-btn">Publish</button>
            </div>
        </mat-card-content>
    </mat-card>
</div>